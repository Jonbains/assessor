/**
 * Agency Transformation Scoring Engine - Enhanced Version
 * 
 * Calculates both transformation readiness and valuation metrics
 * with sophisticated weighting and market benchmarking
 */

export class AgencyTransformationScoring {
    constructor(config = {}) {
      this.config = config;
      
      // Dimension weights for transformation score
      this.transformationWeights = {
        transformation: 0.25,
        resources: 0.20,
        leadership: 0.20,
        change: 0.35
      };
      
      // Valuation dimension weights
      this.valuationWeights = {
        financial: 0.35,
        operational: 0.30,
        strategic: 0.20,
        ai: 0.15
      };
      
      // Question weights by importance
      this.questionWeights = {
        tc: { // Transformation capability
          tc_1: 1.5,  // Current AI usage (critical)
          tc_2: 1.2,  // Process improvement
          tc_3: 1.0,  // Experimentation
          tc_4: 1.3,  // Integration capability
          tc_5: 1.4   // Strategic planning
        },
        rc: { // Resource capability
          rc_1: 1.3,  // Budget availability
          rc_2: 1.1,  // Tool investment
          rc_3: 1.0,  // Training time
          rc_4: 1.4,  // Revenue predictability
          rc_5: 1.2   // Resource allocation
        },
        lc: { // Leadership commitment
          lc_1: 1.5,  // Leadership vision (critical)
          lc_2: 1.2,  // Decision making
          lc_3: 1.3,  // Strategic alignment
          lc_4: 1.1,  // Risk tolerance
          lc_5: 1.4   // Innovation culture
        },
        cr: { // Change readiness
          cr_1: 1.2,  // Past transformations
          cr_2: 1.4,  // AI understanding
          cr_3: 1.3,  // Client readiness  
          cr_4: 1.1,  // Knowledge management
          cr_5: 1.0,  // Team structure
          cr_6: 1.5   // Client concentration
        }
      };
      
      // Service vulnerability baseline scores
      this.serviceVulnerability = {
        content_creation: 85,
        seo_sem: 80,
        digital_marketing: 75,
        media_planning: 70,
        creative_design: 65,
        pr_comms: 60,
        video_production: 55,
        strategy_consulting: 35,
        brand_strategy: 30
      };
      
      // Agency size modifiers
      this.sizeModifiers = {
        '1-10': {
          agility: 1.2,
          resource_constraint: 0.8,
          benchmarks: {
            low: 25,
            average: 40,
            high: 65,
            exceptional: 80
          }
        },
        '11-50': {
          agility: 1.0,
          resource_constraint: 1.0,
          benchmarks: {
            low: 30,
            average: 50,
            high: 70,
            exceptional: 85
          }
        },
        '51-200': {
          agility: 0.8,
          resource_constraint: 1.2,
          benchmarks: {
            low: 35,
            average: 55,
            high: 75,
            exceptional: 90
          }
        },
        '200+': {
          agility: 0.6,
          resource_constraint: 1.3,
          benchmarks: {
            low: 40,
            average: 60,
            high: 80,
            exceptional: 95
          }
        }
      };
      
      // Valuation impact factors
      this.valuationFactors = {
        recurring_revenue: {
          threshold: 40, // % of revenue
          impact: 0.5,   // Multiple increase
          current_avg: 25
        },
        client_concentration: {
          threshold: 20, // Max % per client
          impact: 0.5,
          current_avg: 35
        },
        ai_capability: {
          threshold: 70, // Readiness score
          impact: 1.5,
          current_avg: 30
        },
        process_maturity: {
          threshold: 60,
          impact: 0.3,
          current_avg: 40
        },
        team_capability: {
          threshold: 65,
          impact: 0.7,
          current_avg: 35
        }
      }
    }
  
    /**
     * Main scoring method - enhanced version
     */
    calculateScores(answers, metadata) {
      const { selectedServices = [], agencySize, revenue, agencyType } = metadata;
      
      // Calculate weighted dimension scores
      const dimensionScores = this.calculateWeightedDimensionScores(answers);
      
      // Map to valuation dimensions with context
      const valuationDimensions = this.calculateValuationDimensions(answers, dimensionScores, metadata);
      
      // Calculate service-specific scores with competitive analysis
      const serviceScores = this.calculateServiceScores(answers, selectedServices);
      
      // Calculate aggregate vulnerability metrics
      const vulnerabilityMetrics = this.calculateVulnerabilityMetrics(serviceScores, selectedServices);
      
      // Calculate transformation readiness with size adjustments
      const transformationScore = this.calculateTransformationScore(dimensionScores, agencySize);
      
      // Calculate valuation score with market context
      const valuationScore = this.calculateValuationScore(valuationDimensions, vulnerabilityMetrics);
      
      // Calculate overall score with strategic weighting
      const overallScore = this.calculateOverallScore(transformationScore, valuationScore);
      
      // Determine categories with benchmarking
      const readinessCategory = this.getReadinessCategory(transformationScore, agencySize);
      const valuationCategory = this.getValuationCategory(valuationScore);
      
      // Extract actionable insights
      const insights = this.extractActionableInsights(
        dimensionScores, 
        valuationDimensions, 
        serviceScores, 
        answers,
        metadata
      );
      
      // Calculate specific risk factors with severity
      const riskFactors = this.calculateDetailedRiskFactors(answers, serviceScores, metadata);
      
      // Identify transformation priorities
      const priorities = this.identifyTransformationPriorities(
        dimensionScores,
        serviceScores,
        riskFactors,
        agencySize
      );
      
      // Calculate savings and efficiency potential
      const efficiencyPotential = this.calculateEfficiencyPotential(
        serviceScores,
        selectedServices,
        agencySize,
        revenue
      );
      
      // Market positioning analysis
      const marketPosition = this.analyzeMarketPosition(overallScore, agencySize, agencyType);
      
      return {
        overall: Math.round(overallScore),
        transformation: Math.round(transformationScore),
        valuation: Math.round(valuationScore),
        
        dimensions: {
          transformation: Math.round(dimensionScores.transformation),
          resources: Math.round(dimensionScores.resources),
          leadership: Math.round(dimensionScores.leadership),
          change: Math.round(dimensionScores.change)
        },
        
        valuationDimensions: {
          financial: Math.round(valuationDimensions.financial),
          operational: Math.round(valuationDimensions.operational),
          strategic: Math.round(valuationDimensions.strategic),
          ai: Math.round(valuationDimensions.ai)
        },
        
        serviceScores: serviceScores,
        vulnerabilityMetrics: vulnerabilityMetrics,
        
        categories: {
          readiness: readinessCategory,
          valuation: valuationCategory
        },
        
        riskFactors: riskFactors,
        insights: insights,
        priorities: priorities,
        efficiencyPotential: efficiencyPotential,
        marketPosition: marketPosition,
        
        metadata: {
          agencySize,
          revenue,
          agencyType,
          selectedServices,
          questionCount: Object.keys(answers).length,
          completionRate: this.calculateCompletionRate(answers),
          timestamp: new Date().toISOString()
        }
      }
    }
  
    /**
     * Calculate weighted dimension scores
     */
    calculateWeightedDimensionScores(answers) {
      const dimensions = {
        transformation: { scores: [], weights: [] },
        resources: { scores: [], weights: [] },
        leadership: { scores: [], weights: [] },
        change: { scores: [], weights: [] }
      };
      
      // Process answers with weights
      Object.entries(answers).forEach(([questionId, answer]) => {
        const score = typeof answer === 'object' ? (answer.score || 0) : answer;
        let dimension, weight;
        
        // Determine dimension and weight
        if (questionId.startsWith('tc_')) {
          dimension = 'transformation';
          weight = this.questionWeights.tc[questionId] || 1.0
        } else if (questionId.startsWith('rc_')) {
          dimension = 'resources';
          weight = this.questionWeights.rc[questionId] || 1.0
        } else if (questionId.startsWith('lc_')) {
          dimension = 'leadership';
          weight = this.questionWeights.lc[questionId] || 1.0
        } else if (questionId.startsWith('cr_')) {
          dimension = 'change';
          weight = this.questionWeights.cr[questionId] || 1.0
        }
        
        if (dimension) {
          dimensions[dimension].scores.push(score);
          dimensions[dimension].weights.push(weight)
        }
      });
      
      // Calculate weighted averages
      const dimensionScores = {};
      Object.entries(dimensions).forEach(([dimension, data]) => {
        if (data.scores.length > 0) {
          const weightedSum = data.scores.reduce((sum, score, i) => 
            sum + (score * data.weights[i]), 0
          );
          const totalWeight = data.weights.reduce((sum, w) => sum + w, 0);
          dimensionScores[dimension] = ((weightedSum / totalWeight - 1) / 4) * 100
        } else {
          dimensionScores[dimension] = 50;
        }
      });
      
      return dimensionScores;
    }
  
    /**
     * Calculate valuation dimensions with enhanced mapping
     */
    calculateValuationDimensions(answers, dimensionScores, metadata) {
      const valuationDims = {
        financial: 0,
        operational: 0,
        strategic: 0,
        ai: 0
      };
      
      // Financial health - weighted calculation
      const financialFactors = [;
        { question: 'rc_1', weight: 1.5 }, // Budget flexibility
        { question: 'rc_4', weight: 2.0 }, // Revenue predictability
        { question: 'rc_5', weight: 1.2 }, // Resource allocation
        { question: 'cr_6', weight: 1.8 }  // Client concentration
      ];
      
      let financialSum = 0, financialWeight = 0;
      financialFactors.forEach(factor => {
        const score = answers[factor.question]?.score || answers[factor.question] || 3;
        financialSum += score * factor.weight;
        financialWeight += factor.weight
      });
      
      valuationDims.financial = ((financialSum / financialWeight - 1) / 4) * 100;
      
      // Operational excellence - process and efficiency
      const operationalFactors = [;
        { question: 'tc_2', weight: 1.3 },  // Process improvement
        { question: 'tc_4', weight: 1.5 },  // Integration capability
        { question: 'rc_2', weight: 1.0 },  // Tool investment
        { question: 'cr_1', weight: 1.2 },  // Past transformations
        { question: 'cr_4', weight: 1.4 }   // Knowledge management
      ];
      
      let operationalSum = 0, operationalWeight = 0;
      operationalFactors.forEach(factor => {
        const score = answers[factor.question]?.score || answers[factor.question] || 3;
        operationalSum += score * factor.weight;
        operationalWeight += factor.weight
      });
      
      valuationDims.operational = ((operationalSum / operationalWeight - 1) / 4) * 100;
      
      // Strategic position
      valuationDims.strategic = (
        dimensionScores.leadership * 0.5 +
        ((answers.lc_3?.score || answers.lc_3 || 3) - 1) * 25 * 0.3 +
        ((answers.cr_3?.score || answers.cr_3 || 3) - 1) * 25 * 0.2
      );
      
      // AI capability
      valuationDims.ai = (
        dimensionScores.transformation * 0.6 +
        ((answers.tc_1?.score || answers.tc_1 || 3) - 1) * 25 * 0.2 +
        ((answers.cr_2?.score || answers.cr_2 || 3) - 1) * 25 * 0.2
      );
      
      return valuationDims;
    }
  
    /**
     * Calculate service scores with competitive benchmarking
     */
    calculateServiceScores(answers, selectedServices) {
      const serviceScores = {};
      
      selectedServices.forEach(service => {
        const serviceQuestions = Object.entries(answers);
          .filter(([questionId]) => questionId.includes(service.substring(0, 4)));
          .map(([_, answer]) => typeof answer === 'object' ? answer.score : answer);
        
        if (serviceQuestions.length > 0) {
          const avgScore = serviceQuestions.reduce((a, b) => a + b, 0) / serviceQuestions.length;
          const normalizedScore = ((avgScore - 1) / 4) * 100;
          
          // Get AI opportunity score
          const aiOpportunityQuestion = answers[`${service.substring(0, 7)}_5`];
          const aiOpportunity = aiOpportunityQuestion ? ;
            ((aiOpportunityQuestion.score || aiOpportunityQuestion || 3) - 1) * 25 : 50;
          
          // Calculate competitive position
          const vulnerability = this.serviceVulnerability[service] || 50;
          const competitiveGap = vulnerability - normalizedScore;
          
          serviceScores[service] = {
            score: Math.round(normalizedScore),
            vulnerability: vulnerability,
            adaptability: Math.round(100 - vulnerability + (normalizedScore * 0.3)),
            aiOpportunity: Math.round(aiOpportunity),
            competitiveGap: Math.round(competitiveGap),
            marketPressure: this.calculateMarketPressure(service, vulnerability),
            transformationUrgency: this.calculateTransformationUrgency(
              normalizedScore, 
              vulnerability, 
              aiOpportunity
            ),
            readiness: normalizedScore > 60 ? 'high' : normalizedScore > 40 ? 'medium' : 'low'
          }
        }
      });
      
      return serviceScores;
    }
  
    /**
     * Calculate vulnerability metrics
     */
    calculateVulnerabilityMetrics(serviceScores, selectedServices) {
      if (selectedServices.length === 0) {
        return {
          overall: 50,
          highest: 50,
          average: 50,
          criticalServices: 0
        }
      }
      
      let totalVulnerability = 0;
      let maxVulnerability = 0;
      let criticalCount = 0;
      let weights = [];
      
      selectedServices.forEach(service => {
        const score = serviceScores[service];
        if (score) {
          // Weight by readiness (lower readiness = higher weight)
          const weight = score.readiness === 'low' ? 1.5 : ;
                        score.readiness === 'medium' ? 1.0 : 0.7;
          
          totalVulnerability += score.vulnerability * weight;
          weights.push(weight);
          
          if (score.vulnerability > maxVulnerability) {
            maxVulnerability = score.vulnerability
          }
          
          if (score.vulnerability > 75 && score.readiness === 'low') {
            criticalCount++
          }
        }
      });
      
      const totalWeight = weights.reduce((a, b) => a + b, 0);
      
      return {
        overall: Math.round(totalVulnerability / totalWeight),
        highest: maxVulnerability,
        average: Math.round(totalVulnerability / totalWeight),
        criticalServices: criticalCount,
        atriskRevenue: this.calculateAtRiskRevenue(serviceScores, selectedServices)
      }
    }
  
    /**
     * Calculate transformation score with size adjustments
     */
    calculateTransformationScore(dimensionScores, agencySize) {
      let weightedSum = 0;
      let totalWeight = 0;
      
      Object.entries(this.transformationWeights).forEach(([dimension, weight]) => {
        if (dimensionScores[dimension] !== undefined) {
          weightedSum += dimensionScores[dimension] * weight;
          totalWeight += weight
        }
      });
      
      let baseScore = totalWeight > 0 ? weightedSum / totalWeight : 50;
      
      // Apply size modifiers
      const sizeModifier = this.sizeModifiers[agencySize] || this.sizeModifiers['11-50'];
      
      // Agility bonus for smaller agencies
      if (agencySize === '1-10' && baseScore > 40) {
        baseScore *= sizeModifier.agility
      }
      
      // Resource constraint penalty
      if (dimensionScores.resources < 40) {
        baseScore *= sizeModifier.resource_constraint
      }
      
      return Math.max(0, Math.min(100, baseScore));
    }
  
    /**
     * Calculate valuation score with market context
     */
    calculateValuationScore(valuationDimensions, vulnerabilityMetrics) {
      let weightedSum =const insights = [];
      
      // Transformation insights
      if (dimensionScores.transformation > 70) {
        insights.push({
          type: 'strength',
          priority: 'high',
          message: 'Your AI foundation positions you in the top 20% of agencies',
          action: 'Leverage this advantage to win AI-forward clients',
          impact: 'Revenue growth opportunity'
        })
      } else if (dimensionScores.transformation < 40) {
        insights.push({
          type: 'risk',
          priority: 'critical',
          message: 'Limited AI adoption creates immediate competitive disadvantage',
          action: 'Start with team-wide AI literacy program this week',
          impact: 'Prevent client loss'
        })
      }
      
      // Resource insights
      if (dimensionScores.resources > 60 && dimensionScores.transformation < 50) {
        insights.push({
          type: 'opportunity',
          priority: 'high',
          message: 'You have resources but lack AI direction',
          action: 'Invest in strategic AI roadmap development',
          impact: 'Accelerate transformation by 6 months'
        })
      }
      
      // Leadership insights
      if (dimensionScores.leadership > 70) {
        insights.push({
          type: 'strength',
          priority: 'medium',
          message: 'Leadership alignment is your transformation superpower',
          action: 'Empower leaders as AI champions',
          impact: '3x faster adoption'
        })
      } else if (dimensionScores.leadership < 40) {
        insights.push({
          type: 'blocker',
          priority: 'critical',
          message: 'Leadership skepticism will sabotage AI initiatives',
          action: 'Executive AI immersion session urgently needed',
          impact: 'Unblock transformation'
        })
      }
      
      // Service vulnerability insights
      const criticalServices = Object.entries(serviceScores);
        .filter(([_, score]) => score.vulnerability > 75 && score.readiness === 'low');
        .map(([service]) => service);
      
      if (criticalServices.length > 0) {
        insights.push({
          type: 'threat',
          priority: 'critical',
          message: `${criticalServices.length} core services face immediate AI disruption`,
          action: `Transform ${this.getServiceName(criticalServices[0])} first`,
          impact: 'Protect revenue base'
        })
      }
      
      // Valuation insights
      if (valuationDimensions.financial < 40 && valuationDimensions.ai > 60) {
        insights.push({
          type: 'opportunity',
          priority: 'high',
          message: 'Strong AI capability hindered by weak financials',
          action: 'Focus on recurring revenue and client diversification',
          impact: '+1-2x valuation multiple'
        })
      }
      
      // Client concentration insight
      const clientConcentration = answers.cr_6?.score || answers.cr_6 || 3;
      if (clientConcentration <= 2) {
        insights.push({
          type: 'risk',
          priority: 'high',
          message: 'Major client dependency threatens stability',
          action: 'Urgent business development in similar verticals',
          impact: 'Reduce existential risk'
        })
      }
      
      // Quick win identification
      const quickWinServices = Object.entries(serviceScores);
        .filter(([_, score]) => score.aiOpportunity > 75 && score.score > 50);
        .map(([service]) => service);
      
      if (quickWinServices.length > 0) {
        insights.push({
          type: 'opportunity',
          priority: 'medium',
          message: `Quick AI wins available in ${this.getServiceName(quickWinServices[0])}`,
          action: 'Run 2-week pilot with measurable metrics',
          impact: 'Build momentum and confidence'
        })
      }
      
      // Sort by priority and return top insights;
      const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
      return insights;
        .sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
        .slice(0, 6)
    }
  
    /**
     * Calculate detailed risk factors
     */
    calculateDetailedRiskFactors(answers, serviceScores, metadata) {
      const risks = [];
      
      // Client concentration risk
      const clientConcentration = answers.cr_6?.score || answers.cr_6 || 3;
      if (clientConcentration <= 2) {
        const concentrationLevel = clientConcentration === 1 ? '>50%' : '>30%';
        risks.push({
          factor: 'Client Concentration',
          severity: 'critical',
          currentState: `Major client represents ${concentrationLevel} of revenue`,
          impact: '-1.0-1.5x multiple',
          mitigation: 'Diversify to no client >20% within 12 months',
          timeframe: '12 months'
        })
      }
      
      // Revenue predictability
      const revenuePredictability = answers.rc_4?.score || answers.rc_4 || 3;
      if (revenuePredictability <= 2) {
        const recurringPct = revenuePredictability === 1 ? '<10%' : '<25%';
        risks.push({
          factor: 'Revenue Volatility',
          severity: 'high',
          currentState: `Only ${recurringPct} recurring revenue`,
          impact: '-0.5-1.0x multiple',
          mitigation: 'Convert project clients to retainers',
          timeframe: '6 months'
        })
      }
      
      // Key person dependency
      const keyPerson = answers.cr_4?.score || answers.cr_4 || 3;
      if (keyPerson <= 2) {
        risks.push({
          factor: 'Key Person Risk',
          severity: 'high',
          currentState: 'Critical knowledge concentrated in few people',
          impact: '-0.5x multiple',
          mitigation: 'Document processes and cross-train team',
          timeframe: '3 months'
        })
      }
      
      // Service vulnerability  
      const highVulnerabilityServices = Object.entries(serviceScores);
        .filter(([_, score]) => score.vulnerability > 75 && score.readiness === 'low');
        .map(([service, score]) => ({
          service,
          revenue: this.estimateServiceRevenue(service, metadata)
        }));
      
      if (highVulnerabilityServices.length > 0) {
        const atRiskRevenue = highVulnerabilityServices;
          .reduce((sum, s) => sum + s.revenue, 0);
        
        risks.push({
          factor: 'Service Disruption',
          severity: 'critical',
          currentState: `${highVulnerabilityServices.length} services highly vulnerable`,
          impact: '-0.5-1.5x multiple',
          mitigation: `Transform ${this.getServiceName(highVulnerabilityServices[0].service)} immediately`,
          timeframe: '6 months',
          revenueAtRisk: atRiskRevenue
        })
      }
      
      // AI readiness gap
      const aiReadiness = answers.cr_2?.score || answers.cr_2 || 3;
      const competitorPressure = answers.cr_3?.score || answers.cr_3 || 3;
      
      if (aiReadiness <= 2 && competitorPressure >= 4) {
        risks.push({
          factor: 'Competitive Disadvantage',
          severity: 'high',
          currentState: 'Competitors advancing while you lag',
          impact: '-0.5-1.0x multiple',
          mitigation: 'Accelerated AI adoption program',
          timeframe: '3 months'
        })
      }
      
      // Leadership misalignment
      const leadershipScore = (answers.lc_1?.score || answers.lc_1 || 3);
      if (leadershipScore <= 2) {
        risks.push({
          factor: 'Leadership Resistance',
          severity: 'high',
          currentState: 'Leadership not bought into AI transformation',
          impact: '-0.3-0.5x multiple',
          mitigation: 'Executive AI strategy session',
          timeframe: '1 month'
        })
      }
      
      // Calculate total risk impact
      const totalImpact = risks.reduce((sum, risk) => {
        const impactMatch = risk.impact.match(/-?([\d.]+)/);
        return sum + (impactMatch ? parseFloat(impactMatch[1]) : 0);
      }, 0);
      
      risks.forEach(risk => {
        risk.totalRiskContext = `Part of ${totalImpact.toFixed(1)}x total multiple risk`
      });
      
      return risks;
    }
  
    /**
     * Identify transformation priorities
     */
    identifyTransformationPriorities(dimensionScores, serviceScores, riskFactors, agencySize) {
      const priorities = [];
      
      // Dimension-based priorities
      const weakestDimension = Object.entries(dimensionScores);
        .sort((a, b) => a[1] - b[1])[0];
      
      if (weakestDimension[1] < 40) {
        priorities.push({
          area: weakestDimension[0],
          urgency: 'critical',
          focus: this.getDimensionFocus(weakestDimension[0]),
          impact: `Improve ${weakestDimension[0]} score by 20+ points`,
          timeframe: '30 days'
        })
      }
      
      // Service transformation priorities
      const servicesByUrgency = Object.entries(serviceScores);
        .sort((a, b) => b[1].transformationUrgency - a[1].transformationUrgency);
        .slice(0, 3);
      
      servicesByUrgency.forEach(([service, score], index) => {
        priorities.push({
          area: 'service',
          service: service,
          urgency: index === 0 ? 'critical' : 'high',
          focus: `Transform ${this.getServiceName(service)}`,
          impact: `Reduce vulnerability by ${score.competitiveGap}%`,
          timeframe: index === 0 ? '60 days' : '90 days'
        })
      });
      
      // Risk mitigation priorities
      const criticalRisks = riskFactors.filter(r => r.severity === 'critical');
      criticalRisks.forEach(risk => {
        priorities.push({
          area: 'risk',
          riskFactor: risk.factor,
          urgency: 'critical',
          focus: risk.mitigation,
          impact: `Protect ${risk.impact} valuation`,
          timeframe: risk.timeframe
        })
      });
      
      // Size-specific priorities
      if (agencySize === '1-10') {
        priorities.push({
          area: 'agility',
          urgency: 'high',
          focus: 'Leverage small size for rapid AI adoption',
          impact: 'Outmaneuver larger competitors',
          timeframe: '30 days'
        })
      } else if (parseInt(agencySize.split('-')[0]) > 50) {
        priorities.push({
          area: 'scale',
          urgency: 'high',
          focus: 'Create AI center of excellence',
          impact: 'Scale AI across all teams',
          timeframe: '90 days'
        })
      }
      
      // Sort and limit priorities
      const urgencyOrder = { critical: 0, high: 1, medium: 2, low: 3 };
      return priorities;
        .sort((a, b) => urgencyOrder[a.urgency] - urgencyOrder[b.urgency]);
        .slice(0, 5)
    }
  
    /**
     * Calculate efficiency potential
     */
    calculateEfficiencyPotential(serviceScores, selectedServices, agencySize, revenue) {
      const sizeNum = parseInt(agencySize.split('-')[0]) || 10;
      const avgSalary = 50000; // Assumed average;
      const billableHours = 1600; // Per person per year;
      const hourlyRate = avgSalary / billableHours * 2.5; // With margin;
      
      let totalTimeSavings = 0;
      let affectedRevenue = 0;
      
      selectedServices.forEach(service => {
        const score = serviceScores[service];
        if (score) {
          // Estimate time savings based on AI opportunity
          const timeSavingsPct = score.aiOpportunity * 0.7 / 100; // 70% of opportunity;
          const serviceRevenue = this.estimateServiceRevenue(service, { revenue });
          const serviceHours = serviceRevenue / hourlyRate;
          const hoursSaved = serviceHours * timeSavingsPct;
          
          totalTimeSavings += hoursSaved;
          affectedRevenue += serviceRevenue
        }
      });
      
      const annualHoursSaved = Math.round(totalTimeSavings);
      const annualCostSavings = Math.round(annualHoursSaved * (hourlyRate * 0.4)); // Cost portion;
      const capacityIncrease = Math.round((totalTimeSavings / (sizeNum * billableHours)) * 100);
      
      return {
        annualHoursSaved,
        annualCostSavings,
        capacityIncrease,
        revenueOpportunity: Math.round(annualHoursSaved * hourlyRate * 0.6), // New revenue potential
        headcountEquivalent: (annualHoursSaved / billableHours).toFixed(1),
        roiMonths: this.calculateROIMonths(annualCostSavings, agencySize),
        specificSavings: this.calculateSpecificSavings(serviceScores, selectedServices)
      }
    }
  
    /**
     * Analyze market position
     */
    analyzeMarketPosition(overallScore, agencySize, agencyType) {
      const benchmarks = this.sizeModifiers[agencySize]?.benchmarks || ;
                        this.sizeModifiers['11-50'].benchmarks;
      
      let percentile;
      if (overallScore >= benchmarks.exceptional) {
        percentile = 90 + (overallScore - benchmarks.exceptional) / 
                     (100 - benchmarks.exceptional) * 10
                    } else if (overallScore >= benchmarks.high) {
                        percentile = 70 + (overallScore - benchmarks.high) / 
                                     (benchmarks.exceptional - benchmarks.high) * 20
                      } else if (overallScore >= benchmarks.average) {
                        percentile = 40 + (overallScore - benchmarks.average) / 
                                     (benchmarks.high - benchmarks.average) * 30
                      } else if (overallScore >= benchmarks.low) {
                        percentile = 20 + (overallScore - benchmarks.low) / 
                                     (benchmarks.average - benchmarks.low) * 20
                      } else {
                        percentile = overallScore / benchmarks.low * 20
                      }
                      
                      const position = {
                        percentile: Math.round(percentile),
                        comparison: `You're ahead of ${Math.round(percentile)}% of ${agencySize} agencies`,
                        quartile: this.getQuartile(percentile),
                        trend: this.getMarketTrend(percentile, agencyType),
                        competitiveAdvantage: this.getCompetitiveAdvantage(percentile),
                        marketImplication: this.getMarketImplication(percentile),
                        peerComparison: this.getPeerComparison(overallScore, agencySize, agencyType)
                      };
                      
                      return position;
                    }
                  
                    // Helper methods
                    ;
                    calculateMarketPressure(service, vulnerability) {
                      if (vulnerability >= 80) return 'extreme';
                      if (vulnerability >= 70) return 'high';
                      if (vulnerability >= 60) return 'moderate';
                      if (vulnerability >= 50) return 'emerging';
                      return 'low';
                    }
                    ;
                    calculateTransformationUrgency(readiness, vulnerability, aiOpportunity) {
                      // High vulnerability + low readiness + high opportunity = maximum urgency
                      const urgencyScore = (
                        (vulnerability / 100) * 0.4 +
                        ((100 - readiness) / 100) * 0.3 +
                        (aiOpportunity / 100) * 0.3
                      ) * 100;
                      
                      return Math.round(urgencyScore);
                    }
                    ;
                    calculateAtRiskRevenue(serviceScores, selectedServices) {
                      let atRisk = 0;
                      
                      selectedServices.forEach(service => {
                        const score = serviceScores[service];
                        if (score && score.vulnerability > 70 && score.readiness === 'low') {
                          // Assume equal revenue distribution for simplicity
                          atRisk += (100 / selectedServices.length) * (score.vulnerability / 100)
                        }
                      });
                      
                      return Math.round(atRisk);
                    }
                    ;
                    estimateServiceRevenue(service, metadata) {
                      // Rough estimation based on typical agency revenue distribution
                      const serviceWeights = {
                        creative_design: 0.25,
                        content_creation: 0.20,
                        digital_marketing: 0.20,
                        media_planning: 0.15,
                        strategy_consulting: 0.10,
                        pr_comms: 0.05,
                        seo_sem: 0.05
                      };
                      
                      const weight = serviceWeights[service] || 0.1;
                      const totalRevenue = metadata.revenue || 1000000; // Default 1M;
                      
                      return Math.round(totalRevenue * weight);
                    }
                    ;
                    getServiceName(serviceId) {
                      const serviceNames = {
                        content_creation: "Content Creation",
                        creative_design: "Creative & Design",
                        digital_marketing: "Digital Marketing",
                        media_planning: "Media Planning & Buying",
                        seo_sem: "SEO/SEM",
                        pr_comms: "PR & Communications",
                        video_production: "Video Production",
                        strategy_consulting: "Strategy & Consulting",
                        brand_strategy: "Brand Strategy"
                      };
                      return serviceNames[serviceId] || serviceId;
                    }
                    ;
                    getDimensionFocus(dimension) {
                      const focuses = {
                        transformation: "Build AI capability foundation",
                        resources: "Secure budget and time for transformation",
                        leadership: "Align leadership on AI vision",
                        change: "Develop change management plan"
                      };
                      return focuses[dimension] || "Improve capability";
                    }
                    ;
                    calculateROIMonths(annualSavings, agencySize) {
                      // Estimate investment needed based on agency size
                      const investmentEstimates = {
                        '1-10': 25000,
                        '11-50': 50000,
                        '51-200': 100000,
                        '200+': 200000
                      };
                      
                      const investment = investmentEstimates[agencySize] || 50000;
                      const monthlyReturn = annualSavings / 12;
                      
                      return Math.ceil(investment / monthlyReturn);
                    }
                    ;
                    calculateSpecificSavings(serviceScores, selectedServices) {
                      const savings = {};
                      
                      selectedServices.forEach(service => {
                        const score = serviceScores[service];
                        if (score) {
                          savings[service] = {
                            hoursSaved: Math.round(1000 * (score.aiOpportunity / 100)),
                            tasks: this.getAutomatableTasks(service),
                            implementation: this.getImplementationTime(service)
                          }
                        }
                      });
                      
                      return savings;
                    }
                    ;
                    getAutomatableTasks(service) {
                      const tasks = {
                        content_creation: ["First drafts", "SEO optimization", "Content repurposing"],
                        creative_design: ["Concept generation", "Asset variations", "Resizing"],
                        digital_marketing: ["Campaign optimization", "Audience targeting", "A/B testing"],
                        media_planning: ["Media mix modeling", "Budget allocation", "Performance tracking"],
                        seo_sem: ["Keyword research", "Content optimization", "Competitor analysis"],
                        pr_comms: ["Media monitoring", "Press release drafts", "Sentiment analysis"]
                      };
                      return tasks[service] || ["Process optimization", "Data analysis", "Reporting"];
                    }
                    ;
                    getImplementationTime(service) {
                      const complexity = {
                        content_creation: "4-6 weeks",
                        creative_design: "6-8 weeks",
                        digital_marketing: "8-12 weeks",
                        media_planning: "8-12 weeks",
                        seo_sem: "4-6 weeks",
                        pr_comms: "6-8 weeks"
                      };
                      return complexity[service] || "6-8 weeks";
                    }
                    ;
                    getQuartile(percentile) {
                      if (percentile >= 75) return "Top Quartile";
                      if (percentile >= 50) return "Second Quartile";
                      if (percentile >= 25) return "Third Quartile";
                      return "Bottom Quartile";
                    }
                    ;
                    getMarketTrend(percentile, agencyType) {
                      const trends = {
                        creative: "Creative agencies leading AI adoption for concept generation",
                        digital: "Digital agencies integrating AI across all channels",
                        pr: "PR agencies using AI for media intelligence and content",
                        integrated: "Integrated agencies building AI centers of excellence"
                      };
                      
                      const trend = trends[agencyType] || "Agencies rapidly adopting AI capabilities";
                      
                      if (percentile >= 75) {
                        return `Leading the trend: ${trend}`
                      } else if (percentile >= 50) {
                        return `Keeping pace: ${trend}`
                      } else {
                        return `Falling behind: ${trend}`
                      }
                    }
                    
                    getCompetitiveAdvantage(percentile) {
                      if (percentile >= 90) {
                        return "Significant competitive advantage - win AI-forward clients";
                      } else if (percentile >= 75) {
                        return "Strong position - differentiate on AI capabilities";
                      } else if (percentile >= 50) {
                        return "Competitive parity - need differentiation";
                      } else if (percentile >= 25) {
                        return "Competitive disadvantage - urgent catch-up needed";
                      }
                      return "Severe disadvantage - at risk of obsolescence";
                    }
                    ;
                    getMarketImplication(percentile) {
                      if (percentile >= 75) {
                        return "Position as AI transformation leader to command premium";
                      } else if (percentile >= 50) {
                        return "Accelerate AI adoption to stay competitive";
                      } else if (percentile >= 25) {
                        return "Immediate action required to prevent client loss";
                      }
                      return "Consider partnerships or acquisition for survival";
                    }
                    ;
                    getPeerComparison(score, agencySize, agencyType) {
                      // Simulated peer data for comparison
                      const peerAverages = {
                        creative: { '1-10': 45, '11-50': 55, '51-200': 65, '200+': 75 },
                        digital: { '1-10': 50, '11-50': 60, '51-200': 70, '200+': 80 },
                        pr: { '1-10': 40, '11-50': 50, '51-200': 60, '200+': 70 },
                        integrated: { '1-10': 48, '11-50': 58, '51-200': 68, '200+': 78 }
                      };
                      
                      const peerAvg = peerAverages[agencyType]?.[agencySize] || 55;
                      const difference = score - peerAvg;
                      
                      return {
                        peerAverage: peerAvg,
                        difference: difference,
                        comparison: difference > 0 ? 
                          `${Math.abs(difference)} points ahead of similar agencies` :
                          `${Math.abs(difference)} points behind similar agencies`
                      }
                    }
                    
                    calculateCompletionRate(answers) {
                      const expectedQuestions = 30; // Approximate total;
                      const answered = Object.keys(answers).length;
                      return Math.round((answered / expectedQuestions) * 100);
                    }
                  }
                  
                  // Export for use in assessment system;
                  export default AgencyTransformationScoring;