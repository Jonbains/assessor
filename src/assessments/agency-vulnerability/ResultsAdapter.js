/**
 * ResultsAdapter for agency-vulnerability assessment
 * Transforms raw scoring engine output into a consistent format for the results view
 */

class AgencyVulnerabilityResultsAdapter {
  /**
   * Adapts raw scoring engine results to the format expected by ResultsView
   * @param {Object} rawResults - Raw output from the scoring engine
   * @param {Function} getResponse - Function to retrieve saved responses
   * @returns {Object} - Formatted results object
   */
  adaptResults(rawResults, getResponse) {
    if (!rawResults) {
      console.error('AgencyVulnerabilityResultsAdapter: Received null/undefined rawResults');
      return null;
    }

    console.log('AgencyVulnerabilityResultsAdapter: Processing raw results', Object.keys(rawResults || {}));
    
    // Direct extraction from raw results
    const overallScore = rawResults.overall || 0;
    const dimensionScores = rawResults.dimensions || {};
    
    // Extract insights which contain the priority areas
    const insights = rawResults.insights || [];
    const priorities = insights.filter(insight => insight.priority).sort((a, b) => a.priority - b.priority);
    
    // Create these objects with default values if not present in raw results
    const vulnerabilityMetrics = rawResults.vulnerabilityMetrics || {};
    const serviceScores = rawResults.serviceScores || {};
    
    // Construct default market position data if not available
    const marketPosition = {
      position: overallScore < 40 ? 'Behind Competitors' : overallScore < 70 ? 'On Par with Competitors' : 'Leading the Market',
      percentile: Math.round(overallScore * 0.9), // Approximate percentile based on score
      timeAdvantage: overallScore < 40 ? '1-3 months behind' : '3-6 months advantage',
      competitiveAdvantage: overallScore < 40 ? 'Limited' : overallScore < 70 ? 'Moderate' : 'Significant',
      threatLevel: overallScore < 40 ? 'High' : overallScore < 70 ? 'Moderate' : 'Low'
    };
    
    // Construct default efficiency data if not available
    const efficiencyPotential = {
      overall: Math.round(vulnerabilityMetrics.overall || 50),
      timeRecovered: `${Math.round((vulnerabilityMetrics.average || 50) / 10)} hours/week`,
      costSavings: `${Math.round((vulnerabilityMetrics.overall || 50) * 100 / 25)}k annually`
    };
    
    // Create adapted results format expected by AgencyResultsView
    return {
      // Executive summary section
      executive: {
        headline: `Your Agency is ${marketPosition.position}`,
        subheadline: `You're in the ${marketPosition.percentile}th percentile of agencies`,
        keyMetrics: {
          readinessScore: {
            value: overallScore,
            label: 'Readiness Score',
            interpretation: `${overallScore < 40 ? 'Low' : overallScore < 70 ? 'Medium' : 'High'} readiness`
          },
          efficiencyGain: {
            value: `${efficiencyPotential.overall}%`,
            label: 'Efficiency Potential',
            interpretation: `${efficiencyPotential.timeRecovered} hours/week reclaimed`
          },
          transformationUrgency: {
            value: priorities.length > 0 ? (priorities[0].urgency || 'Medium') : 'Medium',
            label: 'Transformation Urgency',
            interpretation: marketPosition.timeAdvantage
          }
        },
        narrative: `Your agency's AI readiness score is ${overallScore}. ${marketPosition.competitiveAdvantage} competitive advantage with ${marketPosition.threatLevel} threat level.`
      },
      
      // Readiness analysis section
      readiness: {
        dimensions: Object.entries(dimensionScores).map(([key, value]) => ({
          name: key.charAt(0).toUpperCase() + key.slice(1),
          score: Math.round(value),
          description: `Your ${key} score indicates ${value < 40 ? 'significant room for improvement' : value < 70 ? 'moderate capability' : 'strong capability'}.`
        })),
        narrative: `Your agency shows ${overallScore < 40 ? 'concerning vulnerabilities' : overallScore < 70 ? 'moderate preparedness' : 'strong positioning'} in the face of AI disruption. The dimension scores indicate where to focus your transformation efforts.`,
        serviceReadiness: Object.entries(serviceScores).map(([service, data]) => ({
          name: service.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
          score: data?.score || 0,
          interpretation: data?.readiness || 'medium',
          timeToDisruption: data?.score > 70 ? '3-6 months' : data?.score > 40 ? '12-18 months' : '24+ months'
        })),
        transformationPaths: {
          content_creation: "Implement AI writing workflow: Research → AI Draft → Human Edit → AI Optimize. Target: 3x output, same team.",
          creative_design: "AI for ideation and variations: Brief → AI Concepts → Human Curation → AI Production. Deliver 10x options in half the time.",
          digital_marketing: "Automate optimization: AI for copy testing, bid management, audience discovery. Focus humans on strategy and client relations.",
          seo_sem: "AI-powered SEO at scale: Automated audits, content optimization, competitive tracking. Deliver enterprise-level insights to SMBs.",
          pr_comms: "AI for media intelligence: Monitor everything, predict pickup, personalize pitches. Humans focus on relationships and narrative.",
          strategy_consulting: "AI-enhanced insights: Use AI for research, analysis, and scenario modeling. Position as 'data-driven strategy' premium service."
        }
      },
      
      // Opportunities section
      opportunities: {
        immediate: {
          title: 'Priority Transformation Areas',
          subtitle: 'These areas require immediate attention',
          items: priorities.slice(0, 3).map(priority => ({
            title: priority.area || 'Unknown',
            description: priority.description || 'No description available',
            effort: priority.effort || 'Medium',
            impact: priority.impact || 'High'
          }))
        },
        // Add service-specific opportunities
        serviceSpecific: Object.entries(serviceScores)
          .filter(([_, data]) => data?.score > 50) // Focus on vulnerable services
          .map(([service, data]) => {
            // Map service key to proper format for lookup
            const serviceKey = service.toLowerCase().replace(/\s+/g, '_');
            
            // Create default recommendation if specific one not found
            return {
              service: service.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
              title: `AI-Enable ${service.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
              description: `Implement AI tools to transform your ${service.replace(/_/g, ' ')} service, improving efficiency and output quality.`,
              difficulty: data?.score > 70 ? 'high' : 'medium',
              time: `Save ${Math.round(data?.score / 10)} hours/week`,
              impact: 'Significant productivity gain'
            };
          }),
        // Add strategic opportunities
        strategic: [
          {
            title: "AI-First Service Revolution",
            description: "Redesign all services with AI at the core. Not 'AI-enhanced' but 'AI-native'. Deliver 10x value at premium prices.",
            timeline: "6-month transformation",
            impact: "Market leadership position",
            complexity: "high"
          },
          {
            title: "Productize Your Expertise",
            description: "Transform your expertise into AI-powered tools. Package and sell your process as a SaaS offering.",
            timeline: "9-month project",
            impact: "Recurring revenue stream",
            complexity: "high"
          }
        ],
        // Valuation-enhancing opportunities
        valuationImpact: [
          {
            action: "Improve revenue predictability",
            impact: "+0.5-1.0x multiple",
            howTo: "Convert to 40%+ recurring revenue"
          },
          {
            action: "Reduce client concentration",
            impact: "+0.5x multiple",
            howTo: "No client over 20% of revenue"
          },
          {
            action: "Transform vulnerable services",
            impact: "+0.5-1.0x multiple",
            howTo: "AI-enable high-vulnerability services"
          }
        ]
      },
      
      // Roadmap section
      roadmap: {
        overview: {
          title: 'Your AI Transformation Journey',
          approach: 'A phased approach to transform your agency operations'
        },
        phases: [
          {
            title: 'Phase 1: Foundation',
            duration: '0-3 months',
            actions: priorities.slice(0, 2).flatMap(p => p.actions || ['Assess current capabilities', 'Define transformation goals'])
          },
          {
            title: 'Phase 2: Implementation',
            duration: '3-6 months',
            actions: priorities.slice(1, 3).flatMap(p => p.actions || ['Implement pilot projects', 'Develop staff skills'])
          },
          {
            title: 'Phase 3: Optimization',
            duration: '6-12 months',
            actions: ['Scale successful implementations', 'Optimize for maximum efficiency']
          }
        ]
      },
      
      // Impact/valuation section
      impact: {
        title: 'Valuation Impact',
        subtitle: 'How AI transformation affects your agency value',
        current: {
          multiple: `${(2 + (overallScore/100 * 2)).toFixed(1)}x`,
          category: 'Current valuation multiple'
        },
        potential: {
          multiple: `${(3 + (overallScore/100 * 3)).toFixed(1)}x`,
          increase: '+1.5x',
          achievableIn: '12-18 months'
        },
        drivers: [
          {
            driver: 'Operational Efficiency',
            currentImpact: 'Medium',
            potentialImpact: 'High',
            action: `Implement ${priorities[0]?.area || 'AI tools'}`
          },
          {
            driver: 'Revenue Predictability',
            currentImpact: 'Low',
            potentialImpact: 'High',
            action: 'Automate client retention processes'
          },
          {
            driver: 'Margin Improvement',
            currentImpact: 'Medium',
            potentialImpact: 'High',
            action: `${efficiencyPotential.costSavings}`
          }
        ]
      },
      
      // Next steps section
      nextSteps: {
        options: [
          {
            title: 'QuickMap Strategy Session',
            price: 'Free',
            description: '45-minute consultation to review your results and identify immediate opportunities',
            idealFor: 'Understanding your next steps and quick wins'
          },
          {
            title: 'AI Transformation Roadmap',
            price: '$3,500',
            description: 'Comprehensive roadmap development with implementation plan and ROI analysis',
            idealFor: 'Agencies ready to accelerate their AI adoption'
          }
        ],
        testimonial: {
          quote: 'The assessment helped us identify our biggest AI opportunities and prioritize our transformation efforts. We\'ve already seen a 30% increase in efficiency.',
          author: 'Sarah Johnson',
          role: 'CEO, Creative Digital Partners'
        }
      },
      
      // Include the raw data for reference/debugging
      _rawData: rawResults
    };
  }
}

export default AgencyVulnerabilityResultsAdapter;
